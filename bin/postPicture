#!/usr/bin/env node
var SlackBot = require('slackbots');
var request = require('request');
var fs = require('fs');
var file = 'bin/alreadyPosted.txt';
var url = process.env.SITE_URL;
var channel = 'anime-pics';

// create a bot
var bot = new SlackBot({
    token: process.env.SLACK_TOKEN,
    name: 'makibot'
});

bot.on('start', function() {
  var params = {
    as_user: true
  };
  request(url, function(err, res, body){
    if (!err && res.statusCode == 200) {
      var importedJSON = JSON.parse(body);
      fs.readFile(file, 'utf8', function(err, data){
        if ( err ){ throw err;}
        var imageURL = importedJSON.data.children[0].data.url;
        var i = 1;
        console.log(data);
        while(data.indexOf(imageURL) != -1)
        {
          imageURL = importedJSON.data.children[i].data.url;
          i++;
        }
        fs.appendFile(file, '\n' + imageURL, {'encoding':'utf8'}, function(err){
          if ( err ) { throw err; }
            console.log("POSTING...")
            bot.postMessageToChannel(channel, imageURL, params).fail(function(err){
               console.log(err);
            });
        });
      });

    }
    else {
      console.log("ERROR READING JSON");
      bot.postMessageToChannel(channel, 'I\'m having problems!', params);
    }
  });
});
